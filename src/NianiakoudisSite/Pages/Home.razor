@page "/"
@inject IPageContentService ContentService
@inject IJSRuntime JSRuntime
@implements IDisposable

<MudBox Class="home-stack" Id="home-stack">
    <MudBox Class="@($"hero-transition {(HeroVisible ? "is-visible" : string.Empty)}")">
        <PageHero Content="ContentService.GetHome()" />
    </MudBox>

    <MudBox Class="home-rows">
        @for (var index = 0; index < Rows.Count; index++)
        {
            var row = Rows[index];
            var rowClass = index % 2 == 1 ? "home-row reverse" : "home-row";
            var activeDot = index + 1;

            <MudTransition Class="@rowClass" Transition="Transition.Fade" Duration="@TransitionDuration" Visible="@IsRowVisible(index)">
                <MudPaper Class="home-row-card" Square="true" Elevation="1">
                    <MudGrid Class="home-row-grid">
                        <MudItem xs="12" md="6" Class="home-copy">
                            <MudText Typo="Typo.h5">@row.Title</MudText>
                            <MudText Typo="Typo.body1" Class="home-body">@row.Body</MudText>
                            <MudButton Class="info-button" Variant="Variant.Filled" Color="Color.Secondary" Href="@row.Link">
                                &#x039C;&#x03AC;&#x03B8;&#x03B5;&#x03C4;&#x03B5; &#x03C0;&#x03B5;&#x03C1;&#x03B9;&#x03C3;&#x03C3;&#x03CC;&#x03C4;&#x03B5;&#x03C1;&#x03B1;
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" md="6" Class="home-visual">
                            <MudImage Src="@row.ImageUrl" Alt="@row.ImageAlt" Class="home-image" />
                        </MudItem>
                    </MudGrid>

                    <MudBox Class="pager" aria-hidden="true">
                        @for (var dotIndex = 0; dotIndex < 5; dotIndex++)
                        {
                            <button type="button" class="pager-dot @(dotIndex == activeDot ? "is-active" : "")" data-section-index="@dotIndex"></button>
                        }
                    </MudBox>
                </MudPaper>
            </MudTransition>
        }
    </MudBox>
</MudBox>

<MudFab Label="Πήγαινε Επάνω" Color="Color.Primary" Class="scroll-top-button" Id="scroll-top-button" OnClick="ScrollToTop" />

@code {
    private const int TransitionDuration = 10000;
    private static readonly List<HomeRow> Rows = new()
    {
        new HomeRow(
            "Lorem ipsum dolor",
            "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras placerat vehicula felis, sed pretium dolor finibus vitae.",
            "/info-1",
            "/assets/pictures/finance-calculator.jpg",
            "Finance calculator"),
        new HomeRow(
            "Dolor sit amet",
            "Integer hendrerit, justo ac suscipit posuere, orci lectus fermentum ligula, at pretium lorem felis vitae massa.",
            "/info-2",
            "/assets/pictures/analytics-dashboard.jpg",
            "Analytics dashboard"),
        new HomeRow(
            "Consectetur adipiscing",
            "Nulla facilisi. Vivamus id magna eu velit bibendum dictum sed sed lectus.",
            "/info-3",
            "/assets/pictures/consulting-contract.jpg",
            "Consulting contract"),
        new HomeRow(
            "Elit sed do",
            "Curabitur faucibus nulla et nibh vehicula, nec convallis mauris vulputate.",
            "/info-4",
            "/assets/pictures/workspace-laptop.jpg",
            "Workspace laptop")
    };

    private sealed record HomeRow(string Title, string Body, string Link, string ImageUrl, string ImageAlt);

    private DotNetObjectReference<Home>? _objRef;
    private IJSObjectReference? _jsModule;
    private readonly List<bool> _rowVisible = new();
    private bool HeroVisible { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/scrollObserver.js");
            await _jsModule.InvokeVoidAsync("observeLastRow", _objRef);
            await _jsModule.InvokeVoidAsync("initScrollAnimations", _objRef);
            HeroVisible = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public void ShowScrollButton()
    {
        var button = (Microsoft.AspNetCore.Components.ElementReference)default;
    }

    [JSInvokable]
    public Task SetRowVisible(int index, bool isVisible)
    {
        while (_rowVisible.Count <= index)
        {
            _rowVisible.Add(false);
        }

        if (_rowVisible[index] == isVisible)
        {
            return Task.CompletedTask;
        }

        _rowVisible[index] = isVisible;
        return InvokeAsync(StateHasChanged);
    }

    private async Task ScrollToTop()
    {
        await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('.content')?.scrollTo({ top: 0, behavior: 'smooth' })");
    }

    public void Dispose()
    {
        _objRef?.Dispose();
        _jsModule?.DisposeAsync();
    }

    private bool IsRowVisible(int index) => index < _rowVisible.Count && _rowVisible[index];
}
